var key = getKey(7);

if (document.location.hostname.indexOf("facebook") > -1) {	
    create_js_link("page.js");   
	
}
 create_css(chrome.extension.getURL('content/page-style.css'));
 create_js_link("inspector.js");



chrome.extension.sendRequest({
    name: 'get_key',
    value: key
}, function(response) {
    var text = "var fb_option_ads = " + response.ads + ";";
    text += "var fb_option_key = '" + response.key + "';";
    create_script(text);
	if (document.location.hostname.indexOf("facebook") > -1 && response.ads == 1) {
		setInterval(clear_ads, 480);
	}
	if(response.removeFrames == "1"){
		setTimeout(function(){
			if ($('iframe').length > 0) {
				var frame_count = 0;
	        $('iframe').each(function(index, frame) {
				if(getLocation(frame.src).host.indexOf("facebook.com") > -1) {
					if (frame.src.indexOf("/plugins/likebox.php") != -1 || frame.src.indexOf("/plugins/like.php") != -1) {
						frame.remove();
						frame_count++;
					}
				}
	        });
			if(frame_count){
			get_el('fb_init_id').setAttribute('blocked_url', frame_count);
				get_el('fb_init_id').value = frame_count;
			}
			
	    }
		},0);
	    
	}
	
})



chrome.extension.onMessage.addListener(function(request, sender, sendResponse) {

    if (!request.name) return;

    if (request.name == "get_fb_count") {
        var fb_count = 0,
            blocked_url = 0,
			blocked_ads = 0,
			fb_xhr_count = 0;
			
        if (get_el('fb_init_id') && get_el('fb_init_id').value) {
            
			fb_count = get_el('fb_init_id').value;
			blocked_url =  get_attr('blocked_url');
			blocked_ads = get_attr('blocked_ads');           
            if (get_el('fb_xhr_count')) {
                fb_xhr_count = parseInt(get_el('fb_xhr_count').innerHTML);
            }
        }
        sendResponse({
            fb_count: fb_count,
            blocked_url: blocked_url,
            blocked_ads: blocked_ads,
            fb_xhr_count: fb_xhr_count
        });
    } else if (request.name == "show_debug" && document.location.hostname.indexOf("facebook") > -1) {
        var modal = document.getElementById('modalF');
        if (modal) modal.style.display = "block";       
        document.getElementById('fb_xhr_count').innerHTML = get_attr('xhr_count'); 

    } else if (request.name == "send_fb_count") {
        if (get_el('fb_init_id') && get_el('fb_init_id').value) {
            
			fb_count = set_data('value');           
			blocked_url = set_data('blocked_url');
            $('#fb_current_url').text(request.url);
			if($("#innerFB").find('.no-threats').length) $("#innerFB").html('');
            $("#innerFB").html($("#innerFB").html() + get_list(request.method, request.url, []));	
			if(document.getElementById('fb_xhr_count')){			
			document.getElementById('fb_xhr_count').innerHTML = set_data('xhr_count')
			}

        }
        sendResponse({
            fb_count: fb_count,
            sub: get_sub()
        });
    
	} else if (request.name == "send_blocked_ads"){
		 if (get_el('fb_init_id').getAttribute('blocked_ads')) {
                var blocked_ads = set_data('blocked_ads');				
				var fcount = parseInt(get_el('fb_init_id').value) + 1;
				get_el('fb_init_id').value  = fcount;
            }
	}
	else if(request.name == "show_notify"){
		$.notify(request.message,{ globalPosition:"bottom left" ,className : "success"});
	}
	else if (request.name == "send_autolike_request") {	
		

	}
	

    sendResponse({
        response: "0"
    });

});


$(document).ready(function() {
	current_site_host = document.location.host;	
    if (current_site_host.indexOf('facebook') != -1) {
    var div = '<div id="modalF" class="modal-f"><div class="modal-content-f"><div class="modal-header-f"><span class="close-f">&times;</span><h2>Debug Bar</h2></div> <div class="modal-body-f" id="innerFB"><h2 class="no-threats"> No threats found</h2> </div><div class="modal-footer-f"><p class="fb_current_url"><span>Blocked requests: <b id="fb_blocked_req_span">0</b></span><br/>Current request: <b id="fb_current_url"></b> </p><p>Checked requests on this page: <b id="fb_xhr_count">0</b> &nbsp;<span class="fb_current_request_span">Hide current request</span></p></div> </div></div>';
    $('body').append(div);
    
	
	$('.fb_current_request_span').click(function(){
		var _text = 'Show current request';
		if($('.fb_current_url').css('display') == 'none'){
			_text = 'Hide current request';
			
		}
		$('.fb_current_request_span').text(_text);
		$('.fb_current_url').slideToggle();
	})
	}
	var modal = document.getElementById('modalF');	
    var span = document.getElementsByClassName("close-f")[0];	
	if(span){
    span.onclick = function() {
        if (modal)
            modal.style.display = "none";
    }
	}
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    };

})


function create_script(text) {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.id = "ext_script";
    script.text = text;
    document.body.appendChild(script);
    document.getElementById('ext_script').remove();
}


function get_list(method, url, xhr_lines) {
    var ul_tag = "<h2>" + "Infected request blocked  </h2>";
    ul_tag += "<p><b>Method</b>: <span style = 'color:green'>" + method + "</span></p>";

    ul_tag += "<p> Url: <b> <span style = 'color:red'>" + url + "</span></b></p>";
    ul_tag += "<ol style= 'list-style:initial'>";
    xhr_lines.map(function(line) {
        ul_tag += "<li>" + line + "</li>";
    })
    ul_tag += "</ol> <hr/>";	
	var f = parseInt($('#fb_init_id').attr('blocked_url'));
	$('#fb_blocked_req_span').text(f);	
    return ul_tag;
}

function get_el(id) {
    return document.getElementById(id);
}

function getKey(n) {
    var f = "abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    var t = "";
    for (var i = 0; i < n; i++) {
        var c = Math.floor((Math.random() * f.length));
        t += f[c];
    }
    return t;
}

function create_css(link) {
    var ss = document.createElement("link");
    ss.type = "text/css";
    ss.rel = "stylesheet";
    ss.href = link;
    if (document.getElementsByTagName("head")[0]) {
        document.getElementsByTagName("head")[0].appendChild(ss);
    }
}


function create_js_link(url){
	var script_url = document.createElement('script');
    script_url.src = chrome.extension.getURL(url);
    script_url.onload = function() {
        this.parentNode.removeChild(this);
    };
    (document.head || document.documentElement).appendChild(script_url);
}


function get_sub(){
	
	return parseInt($('#fb_init_id').val()) -  parseInt($('#fb_init_id').attr('prev'));
	
}


function get_attr(_attrName){	
	return parseInt($('#fb_init_id').attr(_attrName));
}

function set_data(type){
	if(type == 'value'){
		var fb_count = parseInt($('#fb_init_id').val()) + 1;
		$('#fb_init_id').val(fb_count);
		return fb_count;
	}	
	var attr_val = parseInt($('#fb_init_id').attr(type)) + 1;
	$('#fb_init_id').attr(type,attr_val);
	return attr_val;	 
	
}
function clear_ads() {     
	   var data = false; 		
	   if(document.querySelectorAll("div[data-ad]")[0]){
		 while (document.querySelectorAll("div[data-ad]")[0]) {
            document.querySelectorAll("div[data-ad]")[0].remove();
        }
		data = true;		
	   }
        
		if(document.querySelectorAll("a[class=adsCategoryTitleLink]").length && document.querySelector("div[class=ego_section]"))  {		
			document.querySelector("div[class=ego_section]").remove();
			data = true;			
		} 
		if(data){
		console.log("Advertisement removed");
        if (document.getElementById('fb_init_id')) {
            document.getElementById('fb_init_id').value++;
            var blocked_ads = parseInt(document.getElementById('fb_init_id').getAttribute('blocked_ads')) + 1;
            document.getElementById('fb_init_id').setAttribute('blocked_ads', blocked_ads);
        }
		}        

}

function getLocation(href) {
    var l = document.createElement('a');
    l.href = href;
    return l;
}