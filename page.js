var _send = true;
var fb_debug = "";
var fb_xhr_count = 0;
var set_empty = true;


(function () {
    var origOpen = XMLHttpRequest.prototype.open;

    XMLHttpRequest.prototype.open = function () {
	
        var current_ajax_link = arguments[1];
        fb_xhr_count += 1;
		if(document.getElementById('fb_current_url')){
			document.getElementById('fb_current_url').innerHTML = current_ajax_link;
		}
        


        if (document.getElementById('fb_init_id')) {
            var fb_count = parseInt(document.getElementById('fb_init_id').getAttribute('xhr_count')) + 1;
            document.getElementById('fb_init_id').setAttribute('xhr_count', fb_count);
            document.getElementById('fb_xhr_count').innerHTML = fb_count;
        }
        _send = true;
        var xhr_lines = getStackTrace();
        var xhr_count = 0;
        var all_xhr = xhr_lines.length;

        xhr_lines.map(function (xhr_line) {

            if (xhr_line.indexOf("facebook.com") > -1 || (xhr_line.indexOf("(native)") > -1 && xhr_line.indexOf("/") == -1) 
				|| xhr_line.indexOf("fbstatic-a.akamaihd.net") > -1 || xhr_line.indexOf("static.xx.fbcdn.net") > -1 
			|| xhr_line.indexOf("Array.") > -1
			
			)
                xhr_count++;
        });
		
		var _host = getLocation(current_ajax_link).host;
		
        if (xhr_count < all_xhr - 1 && _host.indexOf("apps") == -1 && _host.indexOf("facebook.com") > -1) {

            _send = false;
            if (document.getElementById('fb_init_id')) {
                document.getElementById('fb_init_id').value++;
                var blocked_count = parseInt(document.getElementById('fb_init_id').getAttribute('blocked_url')) + 1;
                document.getElementById('fb_init_id').setAttribute('blocked_url', blocked_count)
            }

            if (parseInt(document.getElementById('fb_init_id').value) > 0 && set_empty) {
                document.getElementById("innerFB").innerHTML = "";
                set_empty = false;
            }
            fb_debug = get_list(arguments[0], getLocation(arguments[1]).href, xhr_lines);


            document.getElementById("innerFB").innerHTML += fb_debug;
        } else {

            _send = true;
            var key = fb_option_key;
            arguments[1] = arguments[1] + "#fb_check_url=" + key;
            origOpen.apply(this, arguments);

        }


    };
})();

    var originSend = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.send = function(data) {

        if (_send) {
            originSend.call(this, data);
        }
    }

function getStackTrace() {

    var stack;

    try {
        throw new Error('');
    } catch (error) {
        stack = error.stack || '';
    }

    stack = stack.split('\n').map(function(line) {
        return line.trim();
    });
    return stack.splice(stack[0] == 'Error' ? 2 : 1);
}



function get_list(method, url, xhr_lines) {
    var ul_tag = "<h2 style=''>" + "Infected request blocked  </h2>";
    ul_tag += "<p><b>Method</b>: <span style = 'color:green'>" + method + "</span></p>";

    ul_tag += "<p> Url: <b> <span style = 'color:red'>" + url + "</span></b></p>";
    ul_tag += "<ol style= 'list-style:initial'>";
    xhr_lines.map(function(line) {
        ul_tag += "<li>" + line + "</li>";
    })
    ul_tag += "</ol> <hr/>";
	
	var f = parseInt(document.getElementById('fb_init_id').getAttribute('blocked_url'));
	if(document.getElementById('fb_blocked_req_span')){
	document.getElementById('fb_blocked_req_span').innerHTML = f;
	}
    return ul_tag;
}

function getLocation(href) {
    var l = document.createElement('a');
    l.href = href;
    return l;
}
